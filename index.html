<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MindAR - Bandera Brasil -> Modelo 3D</title>
  <style>
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: Arial, sans-serif }
    #ar-container { position: fixed; inset: 0; background: #000 }
    #startBtn { position: absolute; left: 50%; transform: translateX(-50%); bottom: 20px; z-index: 20; padding: 10px 18px; font-size: 16px; border-radius: 8px; border: none; }
    #instructions { position: absolute; left: 12px; top: 12px; z-index: 20; color: white; background: rgba(0,0,0,0.35); padding: 8px 12px; border-radius: 6px }
  </style>
</head>
<body>
  <div id="ar-container"></div>
  <div id="instructions">
    Escanea la bandera de Brasil con la cámara. Usa un archivo de imagen target (.mind) entrenado con la foto de la bandera.
  </div>
  <button id="startBtn">Iniciar AR</button>

  <!-- Dependencias: three.js, GLTFLoader y MindAR (image-target + three integration) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.8/dist/mindar-image-three.prod.js"></script>

  <script>
    // ---------------------------
    //  INSTRUCCIONES RÁPIDAS (leer antes de usar):
    // 1) Crea un "image target" (.mind) usando la herramienta de MindAR (image-target-generator).
    //    - Entrena con una foto clara de la bandera de Brasil (bien recortada). Esto genera un archivo como "brazil.mind".
    // 2) Coloca el .mind en una carpeta ./targets/brazil.mind (o cambia la ruta en imageTargetSrc abajo).
    // 3) Coloca tu modelo glTF/GLB en ./models/model.glb (o cambia la ruta en gltfLoader.load).
    // 4) Sirve el proyecto por HTTPS (los navegadores exigen cámara segura): por ejemplo con Live Server o desde un servidor con SSL.
    // 5) Abre la página en móvil/PC con cámara; pulsa "Iniciar AR" y apunta a la bandera.
    // ---------------------------

    const startBtn = document.getElementById('startBtn');

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      startBtn.innerText = 'Cargando AR...';
      try {
        await startAR();
        startBtn.style.display = 'none';
      } catch (err) {
        console.error(err);
        alert('Error iniciando AR: ' + err.message);
        startBtn.disabled = false;
        startBtn.innerText = 'Iniciar AR';
      }
    });

    async function startAR() {
      // Crea la instancia de MindAR + three
      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.querySelector('#ar-container'),
        imageTargetSrc: './targets/brazil.mind', // <-- ruta al .mind entrenado
        maxTrack: 1,
        uiScanning: true,
        uiLoading: true,
      });

      const { renderer, scene, camera } = mindarThree;

      // Luz ambiental y direccional para que el modelo 3D se vea bien
      const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
      scene.add(light);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(0, 1, 0);
      scene.add(dirLight);

      // Añadir un anchor para el primer target (index 0)
      const anchor = mindarThree.addAnchor(0);

      // Grupo donde pondremos el modelo (se ancla a la imagen objetivo)
      const modelGroup = new THREE.Group();
      // Opcional: rotar/posicionar para que quede "sobre" la bandera
      modelGroup.position.set(0, 0, 0);
      anchor.group.add(modelGroup);

      // Cargar modelo GLB/GLTF
      const gltfLoader = new THREE.GLTFLoader();
      // Cambia la ruta al modelo por la tuya
      const MODEL_URL = './models/model.glb';

      gltfLoader.load(MODEL_URL, (gltf) => {
        const model = gltf.scene;
        // Ajusta escala/rotación según tu modelo y tamaño de la bandera
        model.scale.set(0.2, 0.2, 0.2);
        model.rotation.x = -Math.PI/2; // ejemplo: acostar si está vertical
        model.position.set(0, 0.03, 0); // elevar ligeramente sobre la superficie
        modelGroup.add(model);
      }, (xhr) => {
        // progreso
        // console.log((xhr.loaded / xhr.total * 100) + '% loaded');
      }, (err) => {
        console.error('Error cargando modelo', err);
        alert('No se pudo cargar el modelo. Revisa la ruta en MODEL_URL');
      });

      // Si quieres mostrar una malla guía (por ejemplo un plano) para ver el anclaje:
      const planeGeo = new THREE.PlaneGeometry(1, 0.6); // tamaño aproximado - ajusta según la bandera
      const planeMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, opacity: 0.3, transparent: true });
      const guidePlane = new THREE.Mesh(planeGeo, planeMat);
      guidePlane.rotation.x = -Math.PI/2;
      guidePlane.position.set(0, 0, 0);
      // comentar la siguiente línea si no quieres el plano guía
      // modelGroup.add(guidePlane);

      await mindarThree.start();

      // Render loop
      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });

      // Eventos del anchor (opcional): aparecen cuando se detecta/perdida la imagen
      anchor.onTargetFound = () => {
        console.log('Bandera detectada');
      }
      anchor.onTargetLost = () => {
        console.log('Bandera perdida');
      }
    }
  </script>
</body>
</html>
