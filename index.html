<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mundial 2026 AR - Banderas</title>

  <!-- Librer√≠as principales -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://aframe.io/releases/1.4.0/aframe-animation-component.min.js"></script>
  <!-- MindAR (usar el build para A-Frame como m√≥dulo). El paquete aframe integra "mindar-image" internamente -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0056A5 0%, #E20020 100%);
      color: white;
      height: 100vh;
      overflow: hidden;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .header {
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      text-align: center;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }
    .ar-container {
      width: 100%;
      height: 80vh;
      margin-top: 60px;
    }
    .control-panel {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      display: flex;
      justify-content: space-around;
      z-index: 1000;
    }
    .control-btn {
      background: #0056A5;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      -webkit-tap-highlight-color: transparent;
    }
    .control-btn:hover {
      background: #E20020;
      transform: scale(1.1);
    }
    .scanning-status {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 1000;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 20px;
      border-radius: 15px;
      z-index: 2000;
      min-width: 300px;
      max-width: 90%;
      display: none;
    }
    .modal.active { display: block; }
    .modal-content { text-align: center; }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    .trivia-option, .poll-option {
      background: #0056A5;
      border: none;
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
    }
    .trivia-option:hover, .poll-option:hover { background: #E20020; }
    .video-container {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }
    video {
      width: 100%;
      border-radius: 10px;
    }
    .filter-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    .filter-btn {
      background: #0056A5;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
    }
    .filter-btn.active {
      background: #E20020;
    }
    .mobile-tap-hint {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 1000;
      font-size: 14px;
      text-align: center;
      display: none;
    }
    /* Overlay de estado de la c√°mara */
    .camera-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .camera-overlay.active { display: flex; }
    .camera-box { background: rgba(0,0,0,0.85); padding: 20px; border-radius: 12px; max-width: 420px; }
    .camera-box button { margin-top: 12px; padding: 10px 16px; border-radius: 8px; border: none; background: #0056A5; color: white; cursor: pointer; }
  </style>
</head>

<body>
  <div class="header">
    <h1>üá¶üá∑ Mundial 2026 AR - Banderas üáßüá∑</h1>
  </div>

  <div class="scanning-status" id="scanningStatus">
    üîç Enfoca la c√°mara a una bandera
  </div>

  <div class="mobile-tap-hint" id="mobileTapHint">
    üëÜ Toca los c√≠rculos para interactuar
  </div>

  <!-- Overlay para errores/estado de la c√°mara -->
  <div id="cameraOverlay" class="camera-overlay" role="dialog" aria-live="polite">
    <div class="camera-box">
      <h2 id="cameraOverlayTitle">No se pudo iniciar la c√°mara</h2>
      <p id="cameraOverlayMsg">Esperando permisos o el acceso a la c√°mara. Aseg√∫rate de permitir c√°mara y cerrar otras apps que la utilicen.</p>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
        <button id="cameraRetryBtn">Reintentar</button>
        <button id="cameraHelpBtn">Ayuda</button>
      </div>
    </div>
  </div>

  <!-- Escena AR -->
  <div class="ar-container">
    <a-scene
      mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
      embedded
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
    >
      <a-camera position="0 0 0" look-controls="enabled: false">
        <a-cursor 
          id="cursor"
          rayOrigin="mouse"
          animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
          animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
          event-set__1="_event: mouseenter; color: springgreen"
          event-set__2="_event: mouseleave; color: black"
          fuse="true"
          fuse-timeout="50">
        </a-cursor>
      </a-camera>

      <!-- TARGET 0 - Argentina -->
      <a-entity mindar-image-target="targetIndex: 0" class="country-target">
        <a-entity id="argentina-model" visible="false">
          <!-- Modelo primitivo para mejor compatibilidad m√≥vil -->
          <a-cylinder 
            class="clickable"
            color="#74ACDF" 
            height="0.8" 
            radius="0.2"
            position="0 0.4 0"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; startEvents: startAnimation">
          </a-cylinder>
          <a-text value="ARGENTINA" 
                  position="0 1.0 0" 
                  align="center" 
                  color="#FFD700">
          </a-text>
        </a-entity>

        <!-- Botones flotantes - Configurados para m√≥vil -->
        <a-entity 
          position="-0.3 0.8 0" 
          class="ar-button clickable" 
          data-action="animateModel" 
          data-target="argentina"
          event-set__mouseenter="scale: 1.2 1.2 1.2"
          event-set__mouseleave="scale: 1 1 1">
          <a-ring color="#0056A5" radius-inner="0.03" radius-outer="0.05"></a-ring>
          <a-text value="üé¨" position="0 0 0.001" align="center" scale="2 2 2"></a-text>
        </a-entity>

        <a-entity 
          position="0 0.8 0" 
          class="ar-button clickable" 
          data-action="showText" 
          data-target="argentina"
          event-set__mouseenter="scale: 1.2 1.2 1.2"
          event-set__mouseleave="scale: 1 1 1">
          <a-ring color="#E20020" radius-inner="0.03" radius-outer="0.05"></a-ring>
          <a-text value="üìù" position="0 0 0.001" align="center" scale="2 2 2"></a-text>
        </a-entity>

        <a-entity 
          position="0.3 0.8 0" 
          class="ar-button clickable" 
          data-action="show3DModel" 
          data-target="argentina"
          event-set__mouseenter="scale: 1.2 1.2 1.2"
          event-set__mouseleave="scale: 1 1 1">
          <a-ring color="#74ACDF" radius-inner="0.03" radius-outer="0.05"></a-ring>
          <a-text value="üèÜ" position="0 0 0.001" align="center" scale="2 2 2"></a-text>
        </a-entity>
      </a-entity>

      <!-- TARGET 1 - Brasil -->
      <a-entity mindar-image-target="targetIndex: 1" class="country-target">
        <a-entity id="brasil-model" visible="false">
          <!-- Modelo primitivo para mejor compatibilidad m√≥vil -->
          <a-sphere 
            class="clickable"
            color="#009C3B" 
            radius="0.3"
            position="0 0.5 0"
            animation="property: rotation; to: 360 360 0; loop: true; dur: 3000; startEvents: startAnimation">
          </a-sphere>
          <a-text value="BRASIL" 
                  position="0 1.0 0" 
                  align="center" 
                  color="#FFDF00">
          </a-text>
        </a-entity>

        <!-- Botones flotantes - Configurados para m√≥vil -->
        <a-entity 
          position="-0.3 0.8 0" 
          class="ar-button clickable" 
          data-action="animateModel" 
          data-target="brasil"
          event-set__mouseenter="scale: 1.2 1.2 1.2"
          event-set__mouseleave="scale: 1 1 1">
          <a-ring color="#009C3B" radius-inner="0.03" radius-outer="0.05"></a-ring>
          <a-text value="üé¨" position="0 0 0.001" align="center" scale="2 2 2"></a-text>
        </a-entity>

        <a-entity 
          position="0 0.8 0" 
          class="ar-button clickable" 
          data-action="showText" 
          data-target="brasil"
          event-set__mouseenter="scale: 1.2 1.2 1.2"
          event-set__mouseleave="scale: 1 1 1">
          <a-ring color="#FFDF00" radius-inner="0.03" radius-outer="0.05"></a-ring>
          <a-text value="üìù" position="0 0 0.001" align="center" scale="2 2 2"></a-text>
        </a-entity>

        <a-entity 
          position="0.3 0.8 0" 
          class="ar-button clickable" 
          data-action="show3DModel" 
          data-target="brasil"
          event-set__mouseenter="scale: 1.2 1.2 1.2"
          event-set__mouseleave="scale: 1 1 1">
          <a-ring color="#009C3B" radius-inner="0.03" radius-outer="0.05"></a-ring>
          <a-text value="‚öΩ" position="0 0 0.001" align="center" scale="2 2 2"></a-text>
        </a-entity>
      </a-entity>
    </a-scene>
  </div>

  <!-- Panel de control -->
  <div class="control-panel">
    <button class="control-btn" onclick="openVideoModal()">üé•</button>
    <button class="control-btn" onclick="openTriviaModal()">‚ùì</button>
    <button class="control-btn" onclick="openPollModal()">üìä</button>
    <button class="control-btn" onclick="show3DModels()">üî∫</button>
    <button class="control-btn" onclick="resetAR()">üîÑ</button>
    <button class="control-btn" onclick="showInfo()">‚ÑπÔ∏è</button>
  </div>

<!-- Modal de Videos -->
  <div id="videoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeVideoModal()">√ó</button>
      <h2>üé• Videos del Mundial</h2>
      
      <div class="filter-buttons">
        <button class="filter-btn active" onclick="applyVideoFilter('none')">Normal</button>
        <button class="filter-btn" onclick="applyVideoFilter('grayscale')">Grises</button>
        <button class="filter-btn" onclick="applyVideoFilter('sepia')">Sepia</button>
      </div>

      <div class="video-option">
        <h3>Argentina vs Brasil</h3>
        <div class="video-container">
          <video id="video1" controls>
            <source src="https://assets.codepen.io/3364143/2020-vw-id3-01.mp4" type="video/mp4">
            Tu navegador no soporta video.
          </video>
        </div>
        <button class="trivia-option" onclick="playVideo('video1')">Reproducir Video</button>
      </div>

      <div class="video-option" style="margin-top: 20px;">
        <h3>Francia vs Alemania</h3>
        <div class="video-container">
          <video id="video2" controls>
            <source src="https://assets.codepen.io/3364143/2020-vw-id3-01.mp4" type="video/mp4">
            Tu navegador no soporta video.
          </video>
        </div>
        <button class="trivia-option" onclick="playVideo('video2')">Reproducir Video</button>
      </div>
    </div>
  </div>

  <!-- Modal de Trivia -->
  <div id="triviaModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeTriviaModal()">√ó</button>
      <h2>‚ùì Trivia del Mundial 2026</h2>
      <div id="triviaQuestion"></div>
      <div id="triviaOptions"></div>
      <div id="triviaResult" style="margin-top: 15px; font-weight: bold;"></div>
      <button class="trivia-option" onclick="nextTriviaQuestion()" style="margin-top: 15px;">Siguiente Pregunta</button>
    </div>
  </div>

  <!-- Modal de Encuestas -->
  <div id="pollModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closePollModal()">√ó</button>
      <h2>üìä Encuestas del Mundial</h2>
      <div id="pollQuestion"></div>
      <div id="pollOptions"></div>
      <div id="pollResult" style="margin-top: 15px; font-weight: bold;"></div>
      <button class="poll-option" onclick="nextPollQuestion()" style="margin-top: 15px;">Siguiente Encuesta</button>
    </div>
  </div>
  <script>
    // === CONFIGURACI√ìN M√ìVIL ===
    document.addEventListener('DOMContentLoaded', function() {
      // Detectar si es m√≥vil
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        console.log("Dispositivo m√≥vil detectado");
        document.body.classList.add('mobile');
      }

      // Configurar eventos t√°ctiles para A-Frame
      setupARTouchEvents();
    });

    function setupARTouchEvents() {
      const scene = document.querySelector('a-scene');
      
      // Esperar a que la escena cargue
      scene.addEventListener('loaded', function() {
        console.log("Escena AR cargada, configurando eventos m√≥viles");
        
        // Mostrar hint para m√≥viles
        setTimeout(() => {
          document.getElementById('mobileTapHint').style.display = 'block';
          setTimeout(() => {
            document.getElementById('mobileTapHint').style.display = 'none';
          }, 5000);
        }, 2000);

        // Configurar eventos de clic para elementos AR
        document.querySelectorAll('.ar-button').forEach(btn => {
          // Evento para desktop
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            handleARButtonClick(this);
          });
          
          // Evento t√°ctil para m√≥vil
          btn.addEventListener('touchstart', function(e) {
            e.stopPropagation();
            e.preventDefault();
            this.setAttribute('scale', '1.1 1.1 1.1');
          });
          
          btn.addEventListener('touchend', function(e) {
            e.stopPropagation();
            e.preventDefault();
            this.setAttribute('scale', '1 1 1');
            handleARButtonClick(this);
          });
        });
      });
    }

    function handleARButtonClick(button) {
      const action = button.getAttribute('data-action');
      const target = button.getAttribute('data-target');
      
      console.log(`Bot√≥n presionado: ${action} para ${target}`);
      
      // Feedback visual
      button.setAttribute('animation', {
        property: 'scale',
        to: '1.3 1.3 1.3',
        dur: 200,
        dir: 'alternate'
      });
      
      setTimeout(() => {
        handleARButton(action, target);
      }, 100);
    }

    // === FUNCIONES AR ACTUALIZADAS ===
    function handleARButton(action, target) {
      console.log(`Ejecutando: ${action} en ${target}`);
      
      switch(action) {
        case 'animateModel':
          animateModel(target);
          break;
        case 'showText':
          showText(target);
          break;
        case 'show3DModel':
          show3DModel(target);
          break;
      }
    }

    function animateModel(country) {
      const model = document.getElementById(`${country}-model`);
      const text = document.getElementById(`${country}-text`);
      
      if (model) {
        model.setAttribute('visible', 'true');
        // Iniciar animaci√≥n
        const animatedElements = model.querySelectorAll('[animation]');
        animatedElements.forEach(el => {
          el.emit('startAnimation');
        });
      }
      
      if (text) text.setAttribute('visible', 'false');
    }

    function showText(country) {
      const model = document.getElementById(`${country}-model`);
      const text = document.getElementById(`${country}-text`);
      
      if (model) model.setAttribute('visible', 'false');
      if (text) text.setAttribute('visible', 'true');
    }

    function show3DModel(country) {
      const model = document.getElementById(`${country}-model`);
      const text = document.getElementById(`${country}-text`);
      
      if (model) {
        model.setAttribute('visible', 'true');
        // Detener animaciones
        const animatedElements = model.querySelectorAll('[animation]');
        animatedElements.forEach(el => {
          el.emit('stopAnimation');
        });
      }
      
      if (text) text.setAttribute('visible', 'false');
    }

    function resetAR() {
      document.querySelectorAll('[id$="-model"], [id$="-text"]').forEach(el => {
        el.setAttribute('visible', 'false');
      });
    }
    // Verificar si las variables ya existen para evitar redeclaraci√≥n
    if (typeof window.triviaData === 'undefined') {
      // === TRIVIA ===
      window.triviaData = [
        { 
          country: "Argentina", 
          questions: [
            { 
              question: "¬øEn qu√© a√±o gan√≥ Argentina su primera Copa del Mundo?", 
              options: ["1978", "1986", "1990", "2014"], 
              correct: 0 
            },
            { 
              question: "¬øQui√©n es el m√°ximo goleador hist√≥rico de Argentina?", 
              options: ["Lionel Messi", "Gabriel Batistuta", "Diego Maradona", "Sergio Ag√ºero"], 
              correct: 1 
            }
          ]
        },
        { 
          country: "Brasil", 
          questions: [
            { 
              question: "¬øCu√°ntas Copas del Mundo tiene Brasil?", 
              options: ["3", "4", "5", "6"], 
              correct: 2 
            },
            { 
              question: "¬øQui√©n es el 'Rey del F√∫tbol' brasile√±o?", 
              options: ["Pel√©", "Ronaldo", "Ronaldinho", "Neymar"], 
              correct: 0 
            }
          ]
        }
      ];

      // Variables globales para la trivia
      window.currentTriviaQuestions = [];
      window.currentQuestionIndex = 0;
      window.score = 0;
    }

    if (typeof window.pollData === 'undefined') {
      // === ENCUESTAS ===
      window.pollData = [
        { 
          country: "Argentina", 
          polls: [
            { 
              question: "¬øQui√©n ser√° el goleador de Argentina en el 2026?", 
              options: ["Lionel Messi", "Juli√°n √Ålvarez", "Lautaro Mart√≠nez", "Ninguno"] 
            },
            { 
              question: "¬øArgentina llegar√° a la final?", 
              options: ["S√≠", "No", "No s√©", "Ojal√°"] 
            },
            { 
              question: "¬øCu√°l es el mejor jugador argentino de la historia?", 
              options: ["Lionel Messi", "Diego Maradona", "Alfredo Di St√©fano", "Gabriel Batistuta"] 
            },
            { 
              question: "¬øEn qu√© fase quedar√° eliminado Argentina?", 
              options: ["Fase de grupos", "Octavos", "Cuartos", "No ser√° eliminado"] 
            },
            { 
              question: "¬øQui√©n deber√≠a ser el capit√°n?", 
              options: ["Lionel Messi", "Emiliano Mart√≠nez", "Cuti Romero", "De Paul"] 
            }
          ]
        },
        { 
          country: "Brasil", 
          polls: [
            { 
              question: "¬øBrasil ganar√° el mundial 2026?", 
              options: ["S√≠", "No", "No s√©", "Ojal√°"] 
            },
            { 
              question: "¬øQui√©n ser√° el mejor jugador brasile√±o?", 
              options: ["Vinicius Jr", "Neymar", "Rodrygo", "Alisson"] 
            },
            { 
              question: "¬øCu√°l es la mayor debilidad de Brasil?", 
              options: ["Defensa", "Mediocampo", "Ataque", "No tiene debilidades"] 
            },
            { 
              question: "¬øBrasil llegar√° a semifinales?", 
              options: ["S√≠", "No", "No s√©", "Ojal√°"] 
            },
            { 
              question: "¬øQui√©n es el mejor entrenador para Brasil?", 
              options: ["Tite", "Ancelotti", "Guardiola", "Klopp"] 
            }
          ]
        }
      ];

      // Variables globales para encuestas
      window.currentPollQuestions = [];
      window.currentPollIndex = 0;
    }

    // === FUNCIONES TRIVIA ===
    function openTriviaModal() {
      // M√©todo compatible para obtener todas las preguntas
      const allQuestions = [];
      for (let i = 0; i < window.triviaData.length; i++) {
        const country = window.triviaData[i];
        for (let j = 0; j < country.questions.length; j++) {
          allQuestions.push(country.questions[j]);
        }
      }
      
      window.currentTriviaQuestions = getRandomQuestions(allQuestions, 5);
      window.currentQuestionIndex = 0; 
      window.score = 0;
      document.getElementById('triviaModal').classList.add('active');
      showTriviaQuestion();
    }

    function closeTriviaModal() { 
      document.getElementById('triviaModal').classList.remove('active'); 
    }

    function getRandomQuestions(questions, count) {
      const shuffled = questions.slice();
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const temp = shuffled[i];
        shuffled[i] = shuffled[j];
        shuffled[j] = temp;
      }
      return shuffled.slice(0, count);
    }

    function showTriviaQuestion() {
      if (window.currentQuestionIndex >= window.currentTriviaQuestions.length) {
        return showTriviaResults();
      }
      
      const q = window.currentTriviaQuestions[window.currentQuestionIndex];
      const qE = document.getElementById('triviaQuestion');
      const oE = document.getElementById('triviaOptions');
      const rE = document.getElementById('triviaResult');
      
      qE.innerHTML = `<h3>${q.question}</h3>`;
      rE.textContent = '';
      rE.style.color = '';
      oE.innerHTML = '';
      
      for (let i = 0; i < q.options.length; i++) {
        const opt = q.options[i];
        const b = document.createElement('button');
        b.className = 'trivia-option'; 
        b.textContent = opt;
        b.onclick = function() { checkAnswer(i); };
        oE.appendChild(b);
      }
    }

    function checkAnswer(selectedIndex) {
      const q = window.currentTriviaQuestions[window.currentQuestionIndex];
      const rE = document.getElementById('triviaResult');
      
      if (selectedIndex === q.correct) { 
        rE.textContent = '‚úÖ ¬°Correcto!'; 
        rE.style.color = '#00FF00'; 
        window.score++; 
      } else { 
        rE.textContent = `‚ùå Incorrecto. La respuesta correcta era: ${q.options[q.correct]}`; 
        rE.style.color = '#FF0000'; 
      }
    }

    function nextTriviaQuestion() { 
      window.currentQuestionIndex++; 
      showTriviaQuestion(); 
    }

    function showTriviaResults() {
      const qE = document.getElementById('triviaQuestion');
      const oE = document.getElementById('triviaOptions');
      const rE = document.getElementById('triviaResult');
      
      qE.innerHTML = `<h3>üéâ Resultado Final</h3>`;
      oE.innerHTML = '';
      rE.textContent = `Obtuviste ${window.score} de ${window.currentTriviaQuestions.length} preguntas correctas`;
      rE.style.color = '#FFD700';
    }

    // === FUNCIONES ENCUESTAS ===
    function openPollModal() {
      const allPolls = [];
      for (let i = 0; i < window.pollData.length; i++) {
        const country = window.pollData[i];
        for (let j = 0; j < country.polls.length; j++) {
          allPolls.push(country.polls[j]);
        }
      }
      
      window.currentPollQuestions = getRandomQuestions(allPolls, 1);
      window.currentPollIndex = 0;
      document.getElementById('pollModal').classList.add('active');
      showPollQuestion();
    }

    function closePollModal() { 
      document.getElementById('pollModal').classList.remove('active'); 
    }

    function showPollQuestion() {
      if (window.currentPollIndex >= window.currentPollQuestions.length) return;
      
      const q = window.currentPollQuestions[window.currentPollIndex];
      const qE = document.getElementById('pollQuestion');
      const oE = document.getElementById('pollOptions');
      const rE = document.getElementById('pollResult');
      
      qE.innerHTML = `<h3>${q.question}</h3>`;
      rE.textContent = '';
      rE.style.color = '';
      oE.innerHTML = '';
      
      for (let i = 0; i < q.options.length; i++) {
        const opt = q.options[i];
        const b = document.createElement('button');
        b.className = 'poll-option'; 
        b.textContent = opt;
        b.onclick = function() { submitPollAnswer(i); };
        oE.appendChild(b);
      }
    }

    function submitPollAnswer(i) {
      const rE = document.getElementById('pollResult');
      rE.textContent = '‚úÖ ¬°Gracias por tu respuesta!';
      rE.style.color = '#00FF00';
    }

    function nextPollQuestion() {
      const allPolls = [];
      for (let i = 0; i < window.pollData.length; i++) {
        const country = window.pollData[i];
        for (let j = 0; j < country.polls.length; j++) {
          allPolls.push(country.polls[j]);
        }
      }
      
      window.currentPollQuestions = getRandomQuestions(allPolls, 1);
      window.currentPollIndex = 0;
      showPollQuestion();
    }

    // === VIDEOS ===
    function openVideoModal() { 
      document.getElementById('videoModal').classList.add('active'); 
      applyVideoFilter('none');
    }

    function closeVideoModal() {
      document.getElementById('videoModal').classList.remove('active');
      document.querySelectorAll('video').forEach(v => v.pause());
    }

    function playVideo(id) {
      document.querySelectorAll('video').forEach(v => { if (v.id !== id) v.pause(); });
      const v = document.getElementById(id);
      v.paused ? v.play() : v.pause();
    }
    
    function applyVideoFilter(filter) {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      document.querySelectorAll('video').forEach(video => {
        switch(filter) {
          case 'grayscale':
            video.style.filter = 'grayscale(100%)';
            break;
          case 'sepia':
            video.style.filter = 'sepia(100%)';
            break;
          default:
            video.style.filter = 'none';
        }
      });
    }

    // === AR BOTONES ===
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.ar-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.getAttribute('data-action');
          const target = btn.getAttribute('data-target');
          handleARButton(action, target);
        });
      });
    });

    function handleARButton(action, target) {
      if (action === 'animateModel') animateModel(target);
      else if (action === 'showText') showText(target);
      else if (action === 'show3DModel') show3DModel(target);
    }

    function animateModel(country) {
      const model = document.getElementById(`${country}-model`);
      const text = document.getElementById(`${country}-text`);
      model.setAttribute('visible', 'true');
      model.emit('startAnimation');
      if (text) text.setAttribute('visible', 'false');
    }

    function showText(country) {
      const model = document.getElementById(`${country}-model`);
      const text = document.getElementById(`${country}-text`);
      if (text) text.setAttribute('visible', 'true');
      if (model) model.setAttribute('visible', 'false');
    }

    function show3DModel(country) {
      const model = document.getElementById(`${country}-model`);
      const text = document.getElementById(`${country}-text`);
      model.setAttribute('visible', 'true');
      if (text) text.setAttribute('visible', 'false');
    }

    function resetAR() {
      document.querySelectorAll('[id$="-model"], [id$="-text"]').forEach(el => el.setAttribute('visible', 'false'));
    }
    
    function show3DModels() {
      alert('Para ver modelos 3D, escanea una bandera y pulsa el bot√≥n üèÜ o ‚öΩ que aparece sobre ella.');
    }

    // === INFO ===
    function showStats() {
      alert('üìä Estad√≠sticas del Mundial 2026\n\n‚Ä¢ 48 equipos\n‚Ä¢ 3 anfitriones\n‚Ä¢ 16 sedes\n‚Ä¢ 80 partidos');
    }

    function showInfo() {
      alert('‚ÑπÔ∏è Mundial 2026 AR\nEscanea banderas para ver contenido interactivo.\n\nFunciones:\n- Videos con filtros\n- Trivia del Mundial\n- Encuestas por pa√≠s\n- Modelos 3D animados');
    }

    // === ESTADO DEL ESCANEO ===
    const scene = document.querySelector('a-scene');
    if (scene) {
      // Escuchar eventos globales que emite MindAR. Usar event.detail para obtener √≠ndice de target.
      scene.addEventListener('targetFound', (e) => {
        console.log('Evento scene targetFound detail=', e && e.detail);
        document.getElementById('scanningStatus').textContent = '‚úÖ Bandera detectada';

        // Determinar √≠ndice del target (compatibilidad con distintas versiones)
        const idx = (e && e.detail && (e.detail.targetIndex ?? e.detail.index)) ?? null;
        if (idx !== null && idx !== undefined) {
          // Buscar el target correspondiente y mostrar su modelo
          const selector = Array.from(document.querySelectorAll('[mindar-image-target]')).find(el => {
            const attr = el.getAttribute('mindar-image-target') || '';
            return attr.includes(`targetIndex: ${idx}`) || attr.includes(`targetIndex:${idx}`);
          });
          if (selector) {
            console.log('Mostrando modelo para targetIndex=', idx, selector);
            const model = selector.querySelector('[id$="-model"]');
            if (model) {
              model.setAttribute('visible', 'true');
              model.querySelectorAll('[animation]').forEach(el => { try { el.emit('startAnimation'); } catch(e){} });
            } else {
              console.warn('No se encontr√≥ *-model dentro del targetIndex', idx);
            }
          } else {
            console.warn('No se encontr√≥ el selector para targetIndex', idx);
          }
        } else {
          // Fallback: intentar mostrar todos los modelos dentro de cualquier target (menos seguro)
          console.log('targetFound sin √≠ndice; mostrando todos los modelos como fallback');
          document.querySelectorAll('[id$="-model"]').forEach(m => m.setAttribute('visible', 'true'));
        }
      });

      scene.addEventListener('targetLost', (e) => {
        console.log('Evento scene targetLost detail=', e && e.detail);
        document.getElementById('scanningStatus').textContent = 'üîç Enfoca la c√°mara a una bandera';

        const idx = (e && e.detail && (e.detail.targetIndex ?? e.detail.index)) ?? null;
        if (idx !== null && idx !== undefined) {
          const selector = Array.from(document.querySelectorAll('[mindar-image-target]')).find(el => {
            const attr = el.getAttribute('mindar-image-target') || '';
            return attr.includes(`targetIndex: ${idx}`) || attr.includes(`targetIndex:${idx}`);
          });
          if (selector) {
            const model = selector.querySelector('[id$="-model"]');
            if (model) {
              model.setAttribute('visible', 'false');
              model.querySelectorAll('[animation]').forEach(el => { try { el.emit('stopAnimation'); } catch(e){} });
            }
          }
        } else {
          // Fallback: ocultar todos
          document.querySelectorAll('[id$="-model"]').forEach(m => m.setAttribute('visible', 'false'));
        }
      });
    }

    // === WATCHDOG/CAMARA ===
    (function setupCameraWatchdog() {
      const overlay = document.getElementById('cameraOverlay');
      const retryBtn = document.getElementById('cameraRetryBtn');
      const helpBtn = document.getElementById('cameraHelpBtn');
      const overlayTitle = document.getElementById('cameraOverlayTitle');
      const overlayMsg = document.getElementById('cameraOverlayMsg');

      let cameraStarted = false;
      // MindAR normalmente emite events relacionados con video en el elemento <a-scene>
      const sc = document.querySelector('a-scene');

      function showOverlay(title, msg) {
        overlayTitle.textContent = title;
        overlayMsg.textContent = msg;
        overlay.classList.add('active');
      }

      function hideOverlay() { overlay.classList.remove('active'); }

      // Listener para error conocido
      window.addEventListener('error', (ev) => {
        const m = ev && ev.message ? ev.message : '';
        if (m && /NotReadableError|Could not start video source/i.test(m)) {
          showOverlay('No se puede acceder a la c√°mara', 'Parece que la c√°mara est√° en uso o no est√° disponible. Cierra otras aplicaciones que usen la c√°mara y pulsa Reintentar.');
        }
      });

      // Intentar detectar cuando el video comienza: MindAR usa internal events, pero podemos vigilar cambios en video elements
      const checkInterval = setInterval(() => {
        // buscar elementos de video en la escena
        const video = document.querySelector('video');
        if (video) {
          if (!video.paused || video.readyState >= 2) {
            cameraStarted = true;
            hideOverlay();
            clearInterval(checkInterval);
            console.log('Video/c√°mara aparentemente iniciada');
          }
        }
      }, 800);

      // Despu√©s de un tiempo, si no arranc√≥ la c√°mara, mostrar overlay
      setTimeout(() => {
        if (!cameraStarted) {
          showOverlay('La c√°mara no responde', 'No se detect√≥ la c√°mara. Comprueba permisos y que ninguna otra aplicaci√≥n est√© usando la c√°mara, luego pulsa Reintentar.');
        }
      }, 5000);

      retryBtn.addEventListener('click', () => {
        hideOverlay();
        // intentar reiniciar la p√°gina para re-iniciar getUserMedia y MindAR
        console.log('Reintentando acceso a la c√°mara (recargando p√°gina)');
        location.reload();
      });

      helpBtn.addEventListener('click', () => {
        alert('Pasos recomendados:\n1) Aseg√∫rate de que no hay otra app usando la c√°mara.\n2) En configuraci√≥n del navegador, permite el acceso a la c√°mara.\n3) Recarga esta p√°gina y acepta el permiso cuando el navegador lo pida.');
      });
    })();

    // A√±adir listeners espec√≠ficos por target para asegurar que el modelo
    // correspondiente se muestre/oculte cuando se detecte/mande perder el target.
    // Esto ayuda a diagnosticar por qu√© el modelo no aparece al escanear.
    const aframeScene = document.querySelector('a-scene');
    if (aframeScene) {
      aframeScene.addEventListener('loaded', () => {
        console.log('A-Frame escena cargada: registrando listeners por target');
        const targets = document.querySelectorAll('.country-target');
        targets.forEach((tgt, idx) => {
          // Escuchar targetFound/targetLost en cada entidad objetivo
          tgt.addEventListener('targetFound', () => {
            console.log(`targetFound en country-target index=${idx}`);
            // Buscar dentro del target un elemento con id que termine en -model
            const model = tgt.querySelector('[id$="-model"]');
            if (model) {
              model.setAttribute('visible', 'true');
              // Iniciar cualquier animaci√≥n interna
              model.querySelectorAll('[animation]').forEach(el => {
                try { el.emit('startAnimation'); } catch (e) { /* safe */ }
              });
            } else {
              console.warn('No se encontr√≥ elemento *-model dentro del target', tgt);
            }
            document.getElementById('scanningStatus').textContent = '‚úÖ Bandera detectada';
          });

          tgt.addEventListener('targetLost', () => {
            console.log(`targetLost en country-target index=${idx}`);
            const model = tgt.querySelector('[id$="-model"]');
            if (model) {
              model.setAttribute('visible', 'false');
              model.querySelectorAll('[animation]').forEach(el => {
                try { el.emit('stopAnimation'); } catch (e) { /* safe */ }
              });
            }
            document.getElementById('scanningStatus').textContent = 'üîç Enfoca la c√°mara a una bandera';
          });
        });
      });
    }
    // === DEBUG Y MANEJO DE MODELOS ===
function checkModels() {
  console.log("Verificando modelos 3D...");
  
  // Verificar si los modelos se cargaron
  const argentinaModel = document.querySelector('[gltf-model*="world-cup-trophy"]');
  const brasilModel = document.querySelector('[gltf-model*="soccer-ball"]');
  
  console.log("Modelo Argentina:", argentinaModel);
  console.log("Modelo Brasil:", brasilModel);
  
  // Si los modelos GLTF fallan, mostrar modelos de respaldo
  setTimeout(() => {
    document.querySelectorAll('[gltf-model]').forEach(model => {
      const fallback = model.querySelector('.fallback-model');
      if (fallback && !model.hasLoaded) {
        console.log("Modelo GLTF fall√≥, mostrando respaldo");
        fallback.setAttribute('visible', 'true');
      }
    });
  }, 2000);
}

// Modificar la funci√≥n show3DModel para mejor debug
function show3DModel(country) {
  console.log(`Mostrando modelo 3D para: ${country}`);
  
  const model = document.getElementById(`${country}-model`);
  const text = document.getElementById(`${country}-text`);
  
  if (!model) {
    console.error(`Modelo no encontrado: ${country}-model`);
    return;
  }
  
  model.setAttribute('visible', 'true');
  
  // Forzar la animaci√≥n
  const animatedElement = model.querySelector('[animation]');
  if (animatedElement) {
    animatedElement.emit('startAnimation');
    console.log("Animaci√≥n iniciada");
  }
  
  if (text) text.setAttribute('visible', 'false');
  
  // Verificar el estado despu√©s de un momento
  setTimeout(() => {
    console.log(`Modelo ${country} visible:`, model.getAttribute('visible'));
  }, 500);
}

// Verificar modelos cuando la escena cargue
document.querySelector('a-scene').addEventListener('loaded', checkModels);

// === DEBUG ADICIONAL: escuchar eventos targetFound/targetLost en captura ===
(function setupDebugEventCapture() {
  function logEvent(e) {
    try {
      console.log('CAPTURE EVENT:', e.type, 'target=', e.target, 'currentTarget=', e.currentTarget, 'detail=', e.detail);
      // si el evento tiene √≠ndice, intentar mapear al selector
      const idx = (e && e.detail && (e.detail.targetIndex ?? e.detail.index)) ?? null;
      if (idx !== null) console.log('CAPTURE: √≠ndice detectado=', idx);

      // Mostrar estado de modelos dentro del elemento que recibi√≥ el evento
      const el = e.target && e.target.nodeType === 1 ? e.target : document;
      const argentina = el.querySelector ? el.querySelector('#argentina-model') : null;
      const brasil = el.querySelector ? el.querySelector('#brasil-model') : null;
      console.log('CAPTURE: argentina-model (from event target) =', argentina ? argentina.getAttribute('visible') : 'no-encontrado');
      console.log('CAPTURE: brasil-model (from event target) =', brasil ? brasil.getAttribute('visible') : 'no-encontrado');
    } catch (err) {
      console.error('Error en logEvent debug:', err);
    }
  }

  // Capturar en document y en la escena (capturing=true)
  document.addEventListener('targetFound', logEvent, true);
  document.addEventListener('targetLost', logEvent, true);
  const sc = document.querySelector('a-scene');
  if (sc) {
    sc.addEventListener('targetFound', logEvent, true);
    sc.addEventListener('targetLost', logEvent, true);
  }

  // Monitor peri√≥dico del estado de los modelos principales
  setInterval(() => {
    const a = document.getElementById('argentina-model');
    const b = document.getElementById('brasil-model');
    console.log('MONITOR: argentina-model visible=', a ? a.getAttribute('visible') : 'no-encontrado', ' brasil-model visible=', b ? b.getAttribute('visible') : 'no-encontrado');
  }, 3000);
})();
  </script>
</body>
</html>